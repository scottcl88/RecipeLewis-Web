@page "/add-recipe"
@using RecipeLewis.Models
@using RecipeLewis.Models.Requests
@attribute [Authorize]
@inject IRecipeService RecipeService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@*Inject JSRuntime to allow JavaScript Interop *@
@inject IJSRuntime JSRuntime

<PageTitle>Add Recipe</PageTitle>

<MudGrid>
    <MudItem xs="12" sm="7" lg="12">
        <MudPaper Class="pa-4">
            <MudForm @ref="form" @bind-IsValid="@isValid">
                <MudTextField T="string" Label="Title" @bind-value="model.Title" Required="true" RequiredError="Title is required!" />
                <MudTextField T="string" Label="Description" @bind-value="model.Description" Lines="3" />
                <MudTextField T="string" Label="Storage" @bind-value="model.Storage" Lines="3" />
                <MudTextField T="string" Label="Yield" @bind-value="model.Yield" />
                <MudTextField T="string" Label="Nutrition" @bind-value="model.Nutrition" />
                <MudTextField T="string" Label="Author" @bind-value="model.Author" />
                <MudTimePicker Label="Cook Time" @bind-Time="model.CookTime" />
                <MudTimePicker Label="Prep Time" @bind-Time="model.PrepTime" />
                <MudTimePicker Label="Total Time" @bind-Time="model.TotalTime" />
                <MudSelect T="string" Label="Category" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="@("Cappuccino")" />
                    <MudSelectItem Value="@("Cafe Latte")" />
                    <MudSelectItem Value="@("Espresso")" />
                </MudSelect>
                <MudItem class="mt-2">
                    <label class="mud-input-label">Ingredients</label>
                    <div id="ingredientsToolbar">
                        <span class="ql-formats">
                            <select class="ql-font">
                                <option selected=""></option>
                                <option value="serif"></option>
                                <option value="monospace"></option>
                            </select>
                            <select class="ql-size">
                                <option value="small"></option>
                                <option selected=""></option>
                                <option value="large"></option>
                                <option value="huge"></option>
                            </select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-bold"></button>
                            <button class="ql-italic"></button>
                            <button class="ql-underline"></button>
                            <button class="ql-strike"></button>
                        </span>
                        <span class="ql-formats">
                            <select class="ql-color"></select>
                            <select class="ql-background"></select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-list" value="ordered"></button>
                            <button class="ql-list" value="bullet"></button>
                            <button class="ql-indent" value="-1"></button>
                            <button class="ql-indent" value="+1"></button>
                            <select class="ql-align">
                                <option selected=""></option>
                                <option value="center"></option>
                                <option value="right"></option>
                                <option value="justify"></option>
                            </select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-link"></button>
                        </span>
                    </div>
                    <div @ref="@divIngredientsEditorElement" />

                </MudItem>
                <MudItem class="mt-2">
                    <label class="mud-input-label">Directions</label>
                    <div id="directionsToolbar" >
                        <span class="ql-formats">
                            <select class="ql-font">
                                <option selected=""></option>
                                <option value="serif"></option>
                                <option value="monospace"></option>
                            </select>
                            <select class="ql-size">
                                <option value="small"></option>
                                <option selected=""></option>
                                <option value="large"></option>
                                <option value="huge"></option>
                            </select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-bold"></button>
                            <button class="ql-italic"></button>
                            <button class="ql-underline"></button>
                            <button class="ql-strike"></button>
                        </span>
                        <span class="ql-formats">
                            <select class="ql-color"></select>
                            <select class="ql-background"></select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-list" value="ordered"></button>
                            <button class="ql-list" value="bullet"></button>
                            <button class="ql-indent" value="-1"></button>
                            <button class="ql-indent" value="+1"></button>
                            <select class="ql-align">
                                <option selected=""></option>
                                <option value="center"></option>
                                <option value="right"></option>
                                <option value="justify"></option>
                            </select>
                        </span>
                        <span class="ql-formats">
                            <button class="ql-link"></button>
                        </span>
                    </div>
                    <div @ref="@divDirectionsEditorElement" />
                </MudItem>
                <div class="d-flex align-center justify-space-between mt-6">
                    <MudButton Disabled="@(loading || !isValid)" OnClick="HandleSubmit" Class="ml-auto" Variant="Variant.Filled" Color="Color.Primary">
                        @if (loading)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ms-2">Working...</MudText>
                        }
                        else
                        {
                            <MudText>Add</MudText>
                        }
                    </MudButton>
                </div>
            </MudForm>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private bool isValid;
    private MudForm form;
    private CreateRecipeRequest model = new CreateRecipeRequest();
    private string error;
    private bool showError;
    private bool loading;
    private string strSavedContent = "";
    private ElementReference divIngredientsEditorElement;
    private ElementReference divDirectionsEditorElement;
    private string EditorContent;
    private string EditorHTMLContent;
    private bool EditorEnabled = true;

    private async void HandleSubmit()
    {
        loading = true;
        try
        {
            //strSavedContent = await JSRuntime.InvokeAsync<string>(
            //"QuillFunctions.getQuillContent", divIngredientsEditorElement);
            //strSavedContent = await JSRuntime.InvokeAsync<string>(
            //"QuillFunctions.getQuillContent", divDirectionsEditorElement);
            showError = false;
            var result = await RecipeService.Create(model);
            if (result == null)
            {
                Snackbar.Add("An error occured!", Severity.Error, config => { config.ShowCloseIcon = true; });
            }
            else
            {
                Snackbar.Add("Successfully added recipe!", Severity.Success, config => { config.ShowCloseIcon = true; });
                NavigationManager.NavigateTo("/recipes");
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
            showError = true;
            loading = false;
            StateHasChanged();
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeAsync<string>(
                "QuillFunctions.createQuill", divIngredientsEditorElement, "#ingredientsToolbar");
            await JSRuntime.InvokeAsync<string>(
                "QuillFunctions.createQuill", divDirectionsEditorElement, "#directionsToolbar");
        }
    }
}